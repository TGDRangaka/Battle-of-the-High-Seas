var j=Object.defineProperty;var k=(t,e,a)=>e in t?j(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a;var O=(t,e,a)=>(k(t,typeof e!="symbol"?e+"":e,a),a);import{i as F,g as _,a as J,o as K,$ as s,r as f,b as x,e as w,m as X,j as C,f as E,D as g,d as m,u as b,n as Q,l as Z,c as ee}from"./Ship-BgBp64_2.js";class te{constructor(e,a,n){O(this,"isHaveWinner");O(this,"winner");O(this,"selectedCell");this.isHaveWinner=e,this.winner=a,this.selectedCell=n}}const se={apiKey:"AIzaSyAL0AmcXBH1zr7EKL8pE3-Joge0Pxyljfg",authDomain:"battle-of-the-high-seas.firebaseapp.com",databaseURL:"https://battle-of-the-high-seas-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"battle-of-the-high-seas",storageBucket:"battle-of-the-high-seas.appspot.com",messagingSenderId:"95988470782",appId:"1:95988470782:web:b745e9ce5edeeebbe566af",measurementId:"G-ZVDQNVR4JY"};F(se);const u=_(),ie=new URLSearchParams(window.location.search);let p=ie.get("roomId");const Y=J();let T,B,M;K(Y,async t=>{if(t){B=f(u,"users/"+t.uid),T=t.uid;try{M=await x(B),M.exists()}catch(e){console.error("Error fetching user data:",e)}}else Z(Y).catch(e=>{console.error("Error signing in anonymously:",e)})});let R,i,S,$;const z=s("#dropzone");let G;const N=f(u,"rooms/"+p);x(N).then(t=>{if(t.exists()){$=t.val();const e=new Map(Object.entries($.players||{}));s("#roomId").text(`ROOM ID: #${$.roomId}`);const a=e.get(T);a&&(i=a,R=f(u,`rooms/${p}/players/${T}`),s(".player .player-name").text(i.name),i.state===w.NOT_READY&&s(".player button").prop("disabled",!0)),ne(a.board),G=s(".cells"),G&&ae()}else console.error("no room to get...")});X(f(u,`rooms/${p}/players`),t=>{t.exists()&&t.val().id!==T&&(S=t.val(),s(".enemy .player-name").text(S.name),alert("Player Joined!!!"))});let P=!1;C(f(u,`rooms/${p}/players`),async t=>{if(P)return;if((await x(N)).val().status!==E.WAITING){U(),H(),!P&&V();return}const a=new Map(Object.entries(t.val()||{}));let n=[!1,!1];a.forEach((r,d)=>{d===T?r.state!==w.NOT_READY&&(n[0]=!0):r.state!==w.NOT_READY&&s(".enemy button").prop("disabled",!1)&&(n[1]=!0)}),n[0]&&n[1]&&b(N,{status:E.PLAYING}).then(()=>{U(),H(),i.state=w.PLAYING,b(R,i),V()}).catch(r=>console.log("error updating room status to playing",r))});let A=null;function ae(){s(".guide-pane, #dropzone").on("dragstart",".ship",function(t){if(t.preventDefault(),$.status!==E.WAITING)return;A=s(this);const e=i.ships.find(r=>r.id===A.attr("id"));if(!e)return!1;const a=s(this).data("size").split("x"),n=parseInt(a[0]);z.on("dragover",".cell",function(r){r.preventDefault();let d=s(".cell").index(this),o=[];for(let l=0;l<n;l++){let y=e.direction===g.ROW?l:l*10;const D=d+y;o.push(D)}s(".cell").removeClass("highlight"),s(".cell").removeClass("warning"),L(d,e)?o.map(l=>s(".cell").eq(l).addClass("highlight")):o.map(l=>s(".cell").eq(l).addClass("warning"))})}),z.on("drop",".cell",function(t){if($.status!==E.WAITING)return;const e=s(this).data("index"),a=i.ships.find(n=>n.id===A.attr("id"));if(a){if(L(e,a)){t.preventDefault(),s(".cell").removeClass("highlight"),s(".cell").removeClass("warning"),s(this).prepend(A);const n=i.ships.find(r=>r.id===A.attr("id"));n&&(n.index=e,n.status=m.PLACED,i.ships.filter(r=>r.status===m.INACTIVE).length==0?s(".player button").prop("disabled",!1):s(".player button").prop("disabled",!0),b(R,i).catch(r=>console.log("error while updating ships",r)));return}s(".cell").removeClass("highlight"),s(".cell").removeClass("warning")}}),z.on("click",".cell",function(){if($.status!==E.WAITING)return;const t=s(this).data("index"),e=i.ships.find(a=>a.index===t);e&&(le(e,i.ships)?(e.direction===g.COLUMN?(s(".cell").eq(e.index).find(".ship").attr("direction","row"),e.direction=g.ROW):(s(".cell").eq(e.index).find(".ship").attr("direction","column"),e.direction=g.COLUMN),b(R,{ships:i.ships}).catch(a=>console.log("error while updating ships",a))):(s(".cell").eq(t).addClass("warning"),setTimeout(()=>{s(".cell").eq(t).removeClass("warning")},1500)))}),re(i.ships),oe(i.ships)}s(".player button").on("click",function(){i.state===w.NOT_READY&&b(R,{state:w.READY}).then(()=>{}).catch(t=>console.log("error while updating ships",t))});function re(t){for(let e of t)e.status===m.INACTIVE&&s(".guide-pane .ships").append(`
        <div id="${e.id}" class="ship" draggable="true" data-size="${e.size}" direaction="column">
            <img src="../assets/imgs/${e.id}.png" alt="">
        </div>
    `),s(".fleet .ships").append(`
    <div id="${e.id}" class="ship" data-size="${e.size}" direaction="column">
        <img src="../assets/imgs/${e.id}.png" alt="">
    </div>
    `)}function ne(t){const e=t.size*t.size;for(let a=0;a<e;a++)z.append(`<div data-index="${a}" class="cell"></div>`),s("#enemy-board .board").append(`<div data-index="${a}" class="cell"></div>`)}function L(t,e){let a=t%10;const n=Math.floor(t/10);let r=!0;if(e.direction===g.ROW){if(a+e.length>10)return!1;e:for(let d=0;d<e.length;d++){let o=t+d;for(let l of i.ships)if(l.status!==m.INACTIVE&&l.id!==e.id){if(l.direction===g.ROW){if(l.index===o){r=!1;break e}}else for(let y=0;y<l.length;y++)if(o===l.index+y*10){r=!1;break e}}}if(!r)return!1}else{if(n+e.length>10)return!1;e:for(let d=0;d<e.length;d++){let o=t+d*10;for(let l of i.ships)if(l.status!==m.INACTIVE&&l.id!==e.id){if(l.direction===g.COLUMN){if(l.index===o){r=!1;break e}}else for(let y=0;y<l.length;y++)if(o===l.index+y){r=!1;break e}}}if(!r)return!1}return!0}function le(t,e){let a=!0;const n=t.index;if(t.direction===g.ROW){if(Math.floor(n/10)+t.length>10)return!1;for(let r=1;r<t.length;r++){let d=n+r*10;if(d>=100||(e.forEach(o=>{if(o.status!==m.INACTIVE&&o.id!==t.id){if(o.direction===g.COLUMN){if(o.index===d){a=!1;return}}else if(o.index<=d&&o.index+o.length>d){a=!1;return}}}),!a))return!1}}else{if(n%10+t.length>10)return!1;for(let r=1;r<t.length;r++){let d=n+r;if(e.forEach(o=>{if(o.status!==m.INACTIVE&&o.id!==t.id){if(o.direction===g.ROW){if(o.index===d){a=!1;return}}else for(let l=0;l<o.length;l++)if(d===o.index+l*10){a=!1;return}}}),!a)return!1}}return!0}function oe(t){for(let e of t)if(e.status!=m.INACTIVE){const a=e.index,n=e.direction;let r=s(".cell").eq(a);n==g.ROW?r.append(`
                <div id="${e.id}" class="ship" draggable="true" data-size="${e.size}" direction="row">
                    <img src="../assets/imgs/${e.id}.png" alt="">
                </div>
                `):r.append(`
                <div id="${e.id}" class="ship" draggable="true" data-size="${e.size}" direction="column">
                    <img src="../assets/imgs/${e.id}.png" alt="">
                </div>
                `)}i.ships.filter(e=>e.status===m.INACTIVE).length==0?s(".player button").prop("disabled",!1):s(".player button").prop("disabled",!0)}function H(){i.ships.map(t=>{const e=t.index;if(t.direction===g.ROW)for(let n=0;n<t.length;n++)i.board.grid[e+n].inside=t.id;else for(let n=0;n<t.length;n++)i.board.grid[e+n*10].inside=t.id})}function U(){s(".guide-pane").hide(),s(".board-area + .right").show(),s("aside").removeClass("hidden"),s(".player-info button").hide(),s("#dropzone .ship[draggable='true']").attr("draggable","false"),s("#dropzone .ship").css("zIndex","-1"),s("#turnPlayerName").show()}async function V(){if(P)return;s(".cell").append("<div class='shot'></div>"),x(ee(f(u),`rooms/${p}/gameStat`)).then(h=>{h.exists()||b(N,{gameStat:new te(!1,null,-1)}).then(()=>{}).catch(c=>console.error("Error while adding game stat",c))});const t=f(u,`rooms/${p}/turn`),e=f(u,`rooms/${p}/gameStat`),a=f(u,`rooms/${p}/gameStat/isHaveWinner`),n=f(u,`rooms/${p}/gameStat/selectedCell`),r=f(u,`rooms/${p}/players/${S.id}/board/grid`),d=f(u,`rooms/${p}/players/${i.id}/board/grid`);let l=(await x(f(u,`rooms/${p}/players/${S.id}/board/grid`))).val(),D=(await x(f(u,`rooms/${p}/players/${i.id}/board/grid`))).val();C(t,h=>{const c=h.val();s("#turnPlayerName").text(c==i.id?"YOUR TURN":"ENEMY TURN"),s("#turnPlayerName").css("color",c==i.id?"#9DFF21":"#ff2121")}),s("#enemy-board .board").on("click",".cell",async function(){if((await x(t)).val()===i.id){const c=s(this).index();if(l[c].isHit)return;await b(e,{selectedCell:c})}}),C(n,async h=>{const c=h.val(),I=await x(t);if(c!=-1&&I.val()!==i.id){const W=i.board.grid[c];if(i.board.grid[c].isHit=!0,W.inside!=="empty"){let v=i.ships.findIndex(q=>q.id===W.inside);if(!i.ships[v])return;i.ships[v].health>1?(i.ships[v].health=i.ships[v].health-1,i.ships[v].status=m.DAMAGED):(i.ships[v].health=0,i.ships[v].status=m.DESTROYED)}b(R,i).then(async()=>{de(i.ships)&&await b(e,{isHaveWinner:!0,winner:S}),await b(N,{turn:i.id})}).catch(v=>console.log("error updating the player after attack",v))}}),C(d,async h=>{D=h.val(),D.map((c,I)=>{c.isHit&&s("#player-board .board .cell .shot").eq(I).html(c.inside==="empty"?'<img src="../assets/imgs/missed-shot.png" alt="missed"/>':'<img src="../assets/imgs/player-ship-fire.gif" alt="fire"/>')})}),C(r,async h=>{l=h.val(),l.map((c,I)=>{c.isHit&&s("#enemy-board .board .cell .shot").eq(I).html(c.inside==="empty"?'<img src="../assets/imgs/missed-shot.png" alt="missed"/>':'<img src="../assets/imgs/fire.gif" alt="fire"/>')})}),C(a,async h=>{if(h.val()){const I=(await x(f(u,`rooms/${p}/gameStat/winner`))).val();alert("Winner is "+I.name),s("#turnPlayerName").text(I==i.id?"YOUR WIN":"ENEMY WIN"),s("#turnPlayerName").css("color",I==i.id?"#9DFF21":"#ff2121")}}),P=!0}function de(t){return t.filter(e=>e.status===m.DESTROYED).length===t.length}s("#exitButton").click(async function(){await Q(N)});
